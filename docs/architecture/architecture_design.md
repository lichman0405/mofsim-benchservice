# 系统架构设计

## 一、概述

MOFSimBench 服务端采用**分层架构**设计，将系统分为 API 层、业务逻辑层、任务执行层和数据持久层，各层职责明确，便于维护和扩展。

---

## 二、系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              客户端 (Client)                                 │
│                     Python SDK / TUI / HTTP Client                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           API 网关层 (API Gateway)                           │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐ │
│  │   FastAPI   │ │  认证中间件  │ │  限流中间件  │ │     请求日志中间件      │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           业务逻辑层 (Business Layer)                        │
│  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐ ┌─────────────────┐  │
│  │   任务服务     │ │   模型服务     │ │   结构服务     │ │    系统服务     │  │
│  │ TaskService   │ │ ModelService  │ │StructService  │ │  SystemService  │  │
│  └───────────────┘ └───────────────┘ └───────────────┘ └─────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    ▼                 ▼                 ▼
┌─────────────────────────┐ ┌─────────────────┐ ┌─────────────────────────────┐
│     消息队列 (Redis)     │ │  数据库 (PgSQL) │ │      文件存储 (Local)       │
│  ┌─────────────────────┐│ │ ┌─────────────┐ │ │ ┌─────────────────────────┐ │
│  │   Celery Broker     ││ │ │   任务表     │ │ │ │  结构文件 / 模型文件     │ │
│  │   Result Backend    ││ │ │   日志表     │ │ │ │  结果文件 / 日志文件     │ │
│  │   缓存数据          ││ │ │   告警表     │ │ │ └─────────────────────────┘ │
│  └─────────────────────┘│ └─────────────────┘ └─────────────────────────────┘
└─────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         任务执行层 (Worker Layer)                            │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │                          GPU 调度器 (Scheduler)                         ││
│  │   ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                   ││
│  │   │优先级队列 │ │资源分配器 │ │模型缓存  │ │负载均衡  │                   ││
│  │   └──────────┘ └──────────┘ └──────────┘ └──────────┘                   ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ... ┌──────────┐       │
│  │ Worker 0 │ │ Worker 1 │ │ Worker 2 │ │ Worker 3 │     │ Worker 7 │       │
│  │  GPU 0   │ │  GPU 1   │ │  GPU 2   │ │  GPU 3   │     │  GPU 7   │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘     └──────────┘       │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         计算核心层 (MOF Benchmark Core)                      │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│  │  优化任务    │ │  稳定性任务  │ │ 体积模量任务 │ │  热容任务   │            │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘            │
│  ┌─────────────────────────────────────────────────────────────┐            │
│  │                    模型加载器 (Model Loader)                 │            │
│  │   MACE | ORB | OMAT24 | GRACE | MatterSim | SevenNet | ...  │            │
│  └─────────────────────────────────────────────────────────────┘            │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、核心组件说明

### 3.1 API 网关层

| 组件 | 职责 |
|------|------|
| FastAPI | HTTP 请求处理、路由分发、请求验证 |
| 认证中间件 | API Key 验证、权限检查 |
| 限流中间件 | 请求频率控制、防止滥用 |
| 日志中间件 | 请求/响应日志记录 |
| 错误处理 | 统一异常处理、错误响应格式化 |

### 3.2 业务逻辑层

| 服务 | 职责 |
|------|------|
| TaskService | 任务提交、状态查询、结果获取、任务取消 |
| ModelService | 模型列表、模型加载/卸载、自定义模型管理 |
| StructureService | 结构文件上传、验证、管理 |
| SystemService | 系统状态、GPU 状态、队列状态、健康检查 |
| AlertService | 告警规则、告警历史、告警通知 |
| LogService | 日志查询、日志流推送 |

### 3.3 任务执行层

| 组件 | 职责 |
|------|------|
| Celery Worker | 任务执行进程，每个 Worker 绑定一个 GPU |
| GPU Scheduler | GPU 资源调度、任务分配、负载均衡 |
| Priority Queue | 优先级队列管理、任务排序 |
| Model Cache | 模型缓存管理、预加载策略 |
| Callback Handler | 任务完成回调、Webhook 通知 |

### 3.4 数据持久层

| 存储 | 用途 |
|------|------|
| PostgreSQL | 任务元数据、日志、告警、配置 |
| Redis | 消息队列、任务结果缓存、分布式锁 |
| 文件系统 | 结构文件、模型文件、轨迹文件、日志文件 |

---

## 四、数据流设计

### 4.1 任务提交流程

```
Client                API                TaskService           Redis              Worker
  │                    │                     │                   │                   │
  │  POST /tasks       │                     │                   │                   │
  │ ─────────────────► │                     │                   │                   │
  │                    │  validate_request() │                   │                   │
  │                    │ ──────────────────► │                   │                   │
  │                    │                     │  create_task()    │                   │
  │                    │                     │ ─────────────────►│                   │
  │                    │                     │                   │  enqueue_task()  │
  │                    │                     │                   │ ────────────────►│
  │                    │                     │  task_id          │                   │
  │                    │ ◄────────────────── │                   │                   │
  │  202 Accepted      │                     │                   │                   │
  │  {task_id: xxx}    │                     │                   │                   │
  │ ◄───────────────── │                     │                   │                   │
```

### 4.2 任务执行流程

```
Worker              Scheduler           GPU                  Database            Webhook
  │                    │                  │                     │                   │
  │  fetch_next_task() │                  │                     │                   │
  │ ─────────────────► │                  │                     │                   │
  │                    │  allocate_gpu()  │                     │                   │
  │                    │ ───────────────► │                     │                   │
  │  task + gpu_id     │                  │                     │                   │
  │ ◄───────────────── │                  │                     │                   │
  │                    │                  │                     │                   │
  │  update_status(RUNNING)              │                     │                   │
  │ ──────────────────────────────────────────────────────────►│                   │
  │                    │                  │                     │                   │
  │  execute_task()    │                  │                     │                   │
  │ ──────────────────────────────────── ►│                     │                   │
  │                    │                  │  compute...         │                   │
  │  log_progress()    │                  │                     │                   │
  │ ──────────────────────────────────────────────────────────►│                   │
  │                    │                  │                     │                   │
  │  result            │                  │                     │                   │
  │ ◄──────────────────────────────────── │                     │                   │
  │                    │                  │                     │                   │
  │  save_result()     │                  │                     │                   │
  │ ──────────────────────────────────────────────────────────►│                   │
  │                    │                  │                     │                   │
  │  notify_callback() │                  │                     │                   │
  │ ──────────────────────────────────────────────────────────────────────────────►│
  │                    │                  │                     │                   │
  │  release_gpu()     │                  │                     │                   │
  │ ─────────────────► │                  │                     │                   │
```

---

## 五、技术栈

| 层次 | 技术选型 | 说明 |
|------|---------|------|
| Web 框架 | FastAPI | 高性能异步框架，自动 OpenAPI 文档 |
| 任务队列 | Celery | 分布式任务队列，成熟稳定 |
| 消息代理 | Redis | 高性能，同时用于缓存 |
| 数据库 | PostgreSQL | 可靠，支持 JSONB |
| ORM | SQLAlchemy | Python 标准 ORM |
| 数据验证 | Pydantic | 类型验证，与 FastAPI 集成 |
| 日志 | structlog | 结构化日志 |
| 监控 | Prometheus + Grafana | 指标收集与可视化 |
| 容器化 | Docker + Docker Compose | 单机部署 |

---

## 六、部署架构

### 6.1 单机部署拓扑

```
┌─────────────────────────────────────────────────────────────────┐
│                        服务器 (8 × RTX 3090)                     │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    Docker Compose                         │   │
│  │                                                           │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │   │
│  │  │  API Server │  │    Redis    │  │  PostgreSQL │       │   │
│  │  │   :8000     │  │    :6379    │  │    :5432    │       │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘       │   │
│  │                                                           │   │
│  │  ┌─────────────────────────────────────────────────────┐ │   │
│  │  │              Celery Workers (8 个进程)               │ │   │
│  │  │  ┌────────┐ ┌────────┐ ┌────────┐     ┌────────┐   │ │   │
│  │  │  │Worker 0│ │Worker 1│ │Worker 2│ ... │Worker 7│   │ │   │
│  │  │  │ GPU 0  │ │ GPU 1  │ │ GPU 2  │     │ GPU 7  │   │ │   │
│  │  │  └────────┘ └────────┘ └────────┘     └────────┘   │ │   │
│  │  └─────────────────────────────────────────────────────┘ │   │
│  │                                                           │   │
│  │  ┌─────────────┐  ┌─────────────┐                        │   │
│  │  │ Prometheus  │  │   Grafana   │                        │   │
│  │  │   :9090     │  │    :3000    │                        │   │
│  │  └─────────────┘  └─────────────┘                        │   │
│  │                                                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                     数据卷 (Volumes)                      │   │
│  │  /data/structures  /data/models  /data/results  /logs    │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 进程模型

| 进程 | 数量 | 说明 |
|------|------|------|
| API Server | 1 | uvicorn 多 worker 模式 |
| Celery Worker | 8 | 每 GPU 一个 Worker |
| Celery Beat | 1 | 定时任务调度（告警检查等） |
| Redis | 1 | 消息队列和缓存 |
| PostgreSQL | 1 | 数据持久化 |

---

## 七、扩展性设计

### 7.1 任务类型扩展

新增任务类型需要：
1. 在 `core/tasks/` 添加任务执行器
2. 在 `api/schemas/` 添加请求/响应模型
3. 在 `api/routers/tasks.py` 添加路由
4. 在配置文件注册任务类型

### 7.2 模型类型扩展

新增模型框架需要：
1. 在 `core/models/loader.py` 添加加载逻辑
2. 在配置文件添加模型配置
3. 更新模型验证逻辑

### 7.3 通知渠道扩展

新增通知渠道需要：
1. 在 `core/callback/` 添加通知处理器
2. 实现 `NotifierInterface` 接口
3. 在配置文件注册通知渠道

---

## 八、安全设计

| 安全措施 | 说明 |
|---------|------|
| API 认证 | API Key 认证，HTTPS 传输 |
| 输入验证 | Pydantic 严格验证所有输入 |
| 文件安全 | 上传文件类型白名单、大小限制 |
| 资源隔离 | 任务独占 GPU，避免干扰 |
| 日志脱敏 | 敏感信息不记录明文 |

---

*文档版本：v1.0*  
*创建日期：2025年12月30日*
