# 错误码参考

## 一、概述

本文档列出 MOFSimBench API 所有可能返回的错误码及其含义。

---

## 二、错误响应格式

```json
{
  "success": false,
  "error": {
    "code": 40001,
    "message": "错误描述",
    "details": {
      "field": "model",
      "reason": "模型不存在"
    }
  }
}
```

---

## 三、错误码分类

| 范围 | 类别 |
|------|------|
| 40001-40099 | 请求参数错误 |
| 40101-40199 | 认证错误 |
| 40301-40399 | 权限错误 |
| 40401-40499 | 资源不存在 |
| 40901-40999 | 冲突错误 |
| 42201-42299 | 验证错误 |
| 42901-42999 | 速率限制 |
| 50001-50099 | 服务器内部错误 |
| 50301-50399 | 服务不可用 |

---

## 四、请求参数错误 (400)

| 错误码 | 说明 | 解决方案 |
|--------|------|---------|
| 40001 | 请求体格式错误 | 检查 JSON 格式 |
| 40002 | 缺少必需参数 | 添加缺失的参数 |
| 40003 | 参数类型错误 | 检查参数类型 |
| 40004 | 参数值超出范围 | 调整参数值 |
| 40005 | 无效的结构来源 | 使用 builtin/upload |
| 40006 | 无效的优先级 | 使用 CRITICAL/HIGH/NORMAL/LOW |
| 40007 | 无效的任务类型 | 检查任务类型名称 |
| 40008 | 无效的模型名称 | 检查模型是否存在 |
| 40009 | 无效的文件格式 | 使用支持的格式 |
| 40010 | 文件过大 | 减小文件大小 |

**示例**：

```json
{
  "success": false,
  "error": {
    "code": 40002,
    "message": "缺少必需参数",
    "details": {
      "missing_fields": ["model", "structure"]
    }
  }
}
```

---

## 五、认证错误 (401)

| 错误码 | 说明 | 解决方案 |
|--------|------|---------|
| 40101 | 未提供认证信息 | 添加 Authorization header |
| 40102 | 认证格式错误 | 使用 Bearer token 格式 |
| 40103 | API Key 无效 | 检查 API Key |
| 40104 | API Key 已过期 | 重新获取 API Key |
| 40105 | JWT Token 无效 | 重新登录 |
| 40106 | JWT Token 已过期 | 刷新 token |

**示例**：

```json
{
  "success": false,
  "error": {
    "code": 40101,
    "message": "未提供认证信息",
    "details": {
      "hint": "请在 Header 中添加 Authorization: Bearer <api_key>"
    }
  }
}
```

---

## 六、权限错误 (403)

| 错误码 | 说明 | 解决方案 |
|--------|------|---------|
| 40301 | 无权访问该资源 | 检查权限设置 |
| 40302 | API Key 权限不足 | 使用具有足够权限的 Key |
| 40303 | 无权使用该模型 | 联系管理员开通权限 |
| 40304 | 无权取消该任务 | 只能取消自己的任务 |
| 40305 | 操作被禁止 | 联系管理员 |

---

## 七、资源不存在 (404)

| 错误码 | 说明 | 解决方案 |
|--------|------|---------|
| 40401 | 任务不存在 | 检查任务 ID |
| 40402 | 结构文件不存在 | 检查文件 ID |
| 40403 | 模型不存在 | 检查模型名称 |
| 40404 | 结果不存在 | 任务可能未完成 |
| 40405 | 文件不存在 | 检查文件名 |
| 40406 | 内置结构不存在 | 检查结构名称 |

**示例**：

```json
{
  "success": false,
  "error": {
    "code": 40401,
    "message": "任务不存在",
    "details": {
      "task_id": "task_invalid_xxx"
    }
  }
}
```

---

## 八、冲突错误 (409)

| 错误码 | 说明 | 解决方案 |
|--------|------|---------|
| 40901 | 任务已在运行中 | 等待任务完成 |
| 40902 | 任务已完成 | 无需重复操作 |
| 40903 | 任务已取消 | 创建新任务 |
| 40904 | 模型名称已存在 | 使用不同名称 |
| 40905 | 文件正在使用中 | 稍后重试 |

---

## 九、验证错误 (422)

| 错误码 | 说明 | 解决方案 |
|--------|------|---------|
| 42201 | 结构文件无效 | 检查文件格式和内容 |
| 42202 | 原子数超过限制 | 使用更小的结构 |
| 42203 | 不支持的元素 | 检查模型支持的元素 |
| 42204 | 结构几何异常 | 检查原子坐标 |
| 42205 | 周期性设置错误 | 检查晶胞参数 |
| 42206 | 模型文件无效 | 检查模型检查点 |
| 42207 | 参数组合无效 | 检查参数兼容性 |

**示例**：

```json
{
  "success": false,
  "error": {
    "code": 42203,
    "message": "不支持的元素",
    "details": {
      "unsupported_elements": ["Lr", "Og"],
      "model": "mace_off_prod",
      "supported_elements": ["H", "C", "N", "O", ...]
    }
  }
}
```

---

## 十、速率限制 (429)

| 错误码 | 说明 | 解决方案 |
|--------|------|---------|
| 42901 | 请求过于频繁 | 减少请求频率 |
| 42902 | 任务提交限制 | 等待后重试 |
| 42903 | 文件上传限制 | 等待后重试 |

**示例**：

```json
{
  "success": false,
  "error": {
    "code": 42901,
    "message": "请求过于频繁",
    "details": {
      "limit": 100,
      "window_seconds": 60,
      "retry_after_seconds": 30
    }
  }
}
```

---

## 十一、服务器错误 (500)

| 错误码 | 说明 | 解决方案 |
|--------|------|---------|
| 50001 | 内部服务器错误 | 联系管理员 |
| 50002 | 数据库错误 | 稍后重试 |
| 50003 | 缓存错误 | 稍后重试 |
| 50004 | 文件系统错误 | 联系管理员 |
| 50005 | 计算错误 | 检查输入参数 |

---

## 十二、服务不可用 (503)

| 错误码 | 说明 | 解决方案 |
|--------|------|---------|
| 50301 | 服务维护中 | 等待维护完成 |
| 50302 | GPU 资源不足 | 稍后重试 |
| 50303 | 队列已满 | 稍后重试 |
| 50304 | 模型加载失败 | 联系管理员 |

---

## 十三、任务执行错误

这些错误出现在任务结果中，而非 API 响应：

| 错误类型 | 说明 |
|---------|------|
| `OptimizationNotConverged` | 优化未收敛 |
| `MDUnstable` | MD 模拟不稳定 |
| `MemoryError` | 内存不足 |
| `CUDAError` | GPU 计算错误 |
| `TimeoutError` | 执行超时 |
| `ModelError` | 模型推理错误 |

**示例（任务结果）**：

```json
{
  "success": true,
  "data": {
    "task_id": "task_xxx",
    "status": "FAILED",
    "error": {
      "type": "OptimizationNotConverged",
      "message": "优化在 500 步后未收敛",
      "details": {
        "max_force": 0.05,
        "target_fmax": 0.001
      }
    }
  }
}
```

---

## 十四、错误处理最佳实践

1. **检查 HTTP 状态码**：
   - 2xx: 成功
   - 4xx: 客户端错误，需要修改请求
   - 5xx: 服务器错误，可重试

2. **解析错误响应**：
   ```python
   if not response.json()["success"]:
       error = response.json()["error"]
       print(f"错误 {error['code']}: {error['message']}")
   ```

3. **实现重试逻辑**：
   ```python
   import time
   
   for attempt in range(3):
       response = make_request()
       if response.status_code == 429:
           retry_after = response.json()["error"]["details"]["retry_after_seconds"]
           time.sleep(retry_after)
       elif response.status_code >= 500:
           time.sleep(2 ** attempt)
       else:
           break
   ```

---

*文档版本：v1.0*  
*创建日期：2025年12月30日*
