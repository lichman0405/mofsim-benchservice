# 安全与维护指南

## 一、安全性

### 1.1 API 认证
- **API Key**: 所有对 API 的请求必须包含 `X-API-Key` 请求头。
- **密钥管理**: 严禁将 API Key 硬编码在代码中。建议使用环境变量或秘密管理工具（如 HashiCorp Vault）。
- **权限控制**: 目前支持 `ADMIN` 和 `USER` 两种角色。`ADMIN` 可以管理用户和查看所有任务，`USER` 仅能管理自己的任务。

### 1.2 数据安全
- **传输加密**: 生产环境必须启用 HTTPS。
- **输入验证**: 所有上传的 CIF 文件都会经过 Pydantic 模型验证，防止恶意构造的文件导致解析器崩溃。
- **沙箱执行**: 计算任务在隔离的 Docker 容器中运行，限制了对宿主机文件系统的访问。

### 1.3 网络安全
- **防火墙**: 仅开放 80/443 (API/Web) 和 22 (SSH) 端口。
- **内网隔离**: Redis 和 PostgreSQL 应当部署在私有网络中，不直接暴露给公网。

---

## 二、系统维护

### 2.1 日志管理
- **日志位置**: `/var/log/mofsim/`
- **清理策略**: 使用 `logrotate` 每周轮转日志，保留最近 4 周的记录。
- **集中监控**: 建议将日志接入 ELK 或 Loki 进行实时分析。

### 2.2 数据库维护
- **自动备份**: 每日凌晨 2:00 执行全量备份。
- **索引优化**: 每月运行 `VACUUM ANALYZE` 以保持查询性能。
- **迁移管理**: 使用 Alembic 处理数据库模式变更。

### 2.3 镜像更新
- **基础镜像**: 定期更新 NVIDIA PyTorch 基础镜像以获取安全补丁。
- **模型权重**: 模型权重文件存储在 `/data/models`，更新模型时需同步更新该目录并重启 Worker。

---

## 三、故障排除流程

1. **检查服务状态**: `docker compose ps`
2. **查看错误日志**: `docker compose logs --tail=100 api`
3. **验证 GPU 状态**: `nvidia-smi`
4. **测试数据库连接**: `docker exec -it db pg_isready`
5. **检查任务队列**: 访问 Flower 界面 `http://server:5555`

---

## 四、更新日志 (Changelog)

### v1.1.0 (2025-12-15)
- 新增 MACE-OFF 2023.12 支持。
- 优化了超大体系的显存分配策略。
- 修复了 Webhook 重试机制中的指数退避 Bug。

### v1.0.0 (2025-11-01)
- 初始版本发布。
- 支持几何优化、稳定性分析和体积模量计算。

---

*文档版本：v1.0*  
*创建日期：2025年12月30日*
